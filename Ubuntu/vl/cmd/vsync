#!/bin/bash
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
source "${SCRIPT_DIR}/vutil_vars"

function Help {
    echo "Usage:"
    echo "--check"
    echo "    Check if any repo has uncommitted changes."
    echo "--fix"
    echo "    Clone all missing repos."
    echo "--sync"
    echo "    Sync all repos."
    echo "--master"
    echo "    Switch all repos to the master branch."
    echo "--1.0"
    echo "    Switch all repos to the release-1.0 branch."
}

function GitClone {
    git clone git@github.com:vczh-libraries/${1}.git
}

function Check {
    pushd ${VROOT} > /dev/null
    for i in "${GITHUB_REPOS[@]}"; do
        if [ -d "$i" ]; then
            pushd $i > /dev/null
            local STATUS="$(git status --porcelain)"
            if [ "${STATUS}" == "" ]; then
                # Fetch remote-tracking refs so the comparison uses up-to-date information.
                git fetch --prune > /dev/null 2>&1

                # Compare local HEAD with the configured upstream of the current branch.
                # If no upstream is configured, fall back to origin/<current-branch> when it exists.
                local UPSTREAM="$(git rev-parse --abbrev-ref --symbolic-full-name @{upstream} 2>/dev/null)"
                if [ "${UPSTREAM}" == "" ]; then
                    local GITHEAD="$(git symbolic-ref HEAD 2>/dev/null)"
                    local CURRENT_BRANCH="${GITHEAD##refs/heads/}"
                    if git show-ref --verify --quiet "refs/remotes/origin/${CURRENT_BRANCH}"; then
                        UPSTREAM="origin/${CURRENT_BRANCH}"
                    fi
                fi

                if [ "${UPSTREAM}" != "" ]; then
                    # Output format is: <left-count><whitespace><right-count>
                    # For HEAD...UPSTREAM: left = commits reachable from HEAD only (ahead), right = commits reachable from UPSTREAM only (behind).
                    local COUNTS
                    COUNTS="$(git rev-list --left-right --count HEAD...${UPSTREAM} 2>/dev/null)"

                    local AHEAD="0"
                    local BEHIND="0"
                    read -r AHEAD BEHIND <<< "${COUNTS}"

                    if [ "${AHEAD}" == "0" ] && [ "${BEHIND}" == "0" ]; then
                        :
                    elif [ "${AHEAD}" == "0" ] && [ "${BEHIND}" != "0" ]; then
                        printf "${VC_LIGHTGREEN}Repo ${VC_LIGHTBLUE}$i ${VC_LIGHTGREEN}is ${VC_RED}%s behind${VC_DEFAULT} (${UPSTREAM})\n" "${BEHIND}"
                    elif [ "${AHEAD}" != "0" ] && [ "${BEHIND}" == "0" ]; then
                        printf "${VC_LIGHTGREEN}Repo ${VC_LIGHTBLUE}$i ${VC_LIGHTGREEN}is ${VC_RED}%s ahead${VC_DEFAULT} (${UPSTREAM})\n" "${AHEAD}"
                    else
                        printf "${VC_LIGHTGREEN}Repo ${VC_LIGHTBLUE}$i ${VC_LIGHTGREEN}has ${VC_RED}diverged${VC_DEFAULT} (${UPSTREAM}, ahead %s / behind %s)\n" "${AHEAD}" "${BEHIND}"
                    fi
                else
                    printf "${VC_LIGHTGREEN}Repo ${VC_LIGHTBLUE}$i ${VC_LIGHTGREEN}has ${VC_RED}no upstream branch configured${VC_DEFAULT}\n"
                fi
            else
                printf "${VC_LIGHTGREEN}Repo ${VC_LIGHTBLUE}$i ${VC_LIGHTGREEN}has ${VC_RED}uncommitted changes${VC_DEFAULT}\n"
            fi
            popd > /dev/null
        fi
    done
    popd > /dev/null
}

function Fix {
    pushd ${VROOT} > /dev/null
    if ! [ -a load.sh ]; then
        echo "If you want to create a new enlistment, use --enlist."
        exit 1
    fi
    for i in "${GITHUB_REPOS[@]}"; do
        if ! [ -d "$i" ]; then
            git clone git@github.com:vczh-libraries/$i.git
        fi
    done
    popd > /dev/null
}

function Sync {
    vgo u
}

function Master {
    pushd ${VROOT} > /dev/null
    if ! [ -a load.sh ]; then
        echo "If you want to create a new enlistment, use --enlist."
        exit 1
    fi
    for i in "${GITHUB_REPOS_VERSIONED[@]}"; do
        if [ -d "$i" ]; then
            echo "Switch repo $i to master ..."
            pushd $i > /dev/null
            git checkout master
            popd > /dev/null
        fi
    done
    popd > /dev/null
}

function ReleaseOne {
    pushd ${VROOT} > /dev/null
    if ! [ -a load.sh ]; then
        echo "If you want to create a new enlistment, use --enlist."
        exit 1
    fi
    for i in "${GITHUB_REPOS_VERSIONED[@]}"; do
        if [ -d "$i" ]; then
            echo "Switch repo $i to release-1.0 ..."
            pushd $i > /dev/null
            git checkout release-1.0
            popd > /dev/null
        fi
    done
    popd > /dev/null
}

case $1 in
    --help)
    Help
    ;;

    --check)
    Check
    ;;

    --fix)
    Fix
    ;;

    --sync)
    Sync
    ;;

    --master)
    Master
    ;;

    --1.0)
    ReleaseOne
    ;;

    *)
    echo "Use --help for more information."
    ;;
esac
